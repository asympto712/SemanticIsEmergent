---
import Layout from "../layouts/Layout.astro";
const pageTitle = "Onomatopoeia (オノマトペ)"
---

<Layout pageTitle={pageTitle}>
  <div>
    <br/>
    <i>"Onomatopoeia is a type of word, or the process of creating a word, that phonetically imitates, resembles, or suggests a sound that it refers to"</i>
    <p>From wikipedia</p>
  </div>
  <div>
    <h1>"thump thump thump..." (パタンパタンパタン。。)</h1>
    <button id="animateBtn">animate</button>
    <br/>
    <svg width="400" height="800" viewBox="-100 -100 200 400" xmlns="http://www.w3.org/2000/svg">
      <rect x="-100" y="-100" width="100%" height="100%" style="fill:rgb(131, 131, 131);stroke:black;stroke-width:0.5"></rect>
      <g id="rootG">
      <rect id="initRect" x="-40" y="-40" width="80" height="40" style="fill:blue;stroke:red;stroke-width:1;fill-opacity:0.3;"
      transform="skewX(30)">
      </rect>
      <!-- <animateTransform
        attributeName="transform"
        begin="0s"
        dur="1s"
        type="scale"
        from="1,1"
        to="1,-1"
        calcMode="spline"
        keyTimes="0; 1"
        keySplines="0.7 0.1 1 0.2"
        repeatCount="1"
        fill="freeze"
        /> -->
      </g>
    </svg>
    <br/>
  </div>

</Layout>

<script>
  function spawnG(n: number) : SVGGElement {
    const g = document.createElementNS('http://www.w3.org/2000/svg', 'g');
    g.setAttribute('id', `g${n}`);
    g.setAttribute('transform-origin', `0 ${String(n * 40)}`);
    const svg = document.querySelector("svg");
    svg?.appendChild(g);
    return g;
  }
  function spawnRect(g: SVGGElement, n: number, flipped: boolean) : SVGGElement{
    const rect = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
    rect.setAttribute("id", `rect${n}`);
    const theta = Math.PI / 6;
    const y = -40 + n * 40;
    var x = -40;
    if (flipped) x = -40 - 40 * Math.tan(theta);
    rect.setAttribute('transform-origin', `0 ${String(n * 40)}`);
    rect.setAttribute("x", String(x));
    rect.setAttribute("y", String(y));
    rect.setAttribute("width", '80');
    rect.setAttribute("height",'40');
    if (flipped) {
      rect.setAttribute("transform", 'skewX(-30)');
      rect.setAttribute("style", "fill:green;stroke:red;stroke-width:1;fill-opacity:0.3;")
    } else {
      rect.setAttribute("transform", 'skewX(30)');
      rect.setAttribute("style", "fill:blue;stroke:red;stroke-width:1;fill-opacity:0.3;")
    }
    g.appendChild(rect);
    return rect;
  }

  async function beginAnimation(n: number) {
    var flipped: boolean = false;
    for (let i = 0; i <= n; i++) {
      const g = spawnG(i);
      const rect = spawnRect(g, i, flipped);
      const anim = g.animate(patan, patanTiming);
      let colorChange;
      if (flipped) colorChange = rect.animate(fillColChange2, patanTiming);
      else colorChange = rect.animate(fillColChange1, patanTiming);
      if (flipped) flipped = false;
      else flipped = true;
      await anim.finished;
    }
  }

  function animate() {
    const g2 = document.getElementById("g2");
    g2?.remove();
    const g1 = document.getElementById("g1");
    const rect1 = document.getElementById("rect1");
    rect1?.animate(fillColChange1, patanTiming);
    const anim = g1?.animate(patan, patanTiming);
    anim?.addEventListener("finish", (event) => {
      const newG = document.createElementNS('http://www.w3.org/2000/svg', 'g');
      newG.setAttribute("transform-origin", "0 40");
      newG.setAttribute("id", "g2");
      const rect2 = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
      rect2.setAttribute("id", "rect2");
      rect2.setAttribute('width', '80');
      rect2.setAttribute('height', '40');
      rect2.setAttribute('x', '40');
      rect2.setAttribute('y', '0');
      rect2.setAttribute('transform', 'skewX(-30)');
      newG?.appendChild(rect2);
    });
  }

  const patan = [
    { transform: "scale(1,1)"},
    { transform: "scale(1,0.6)", offset: 0.5},
    { transform: "scale(1,0.2)", offset: 0.75},
    { transform: "scale(1,0)", offset: 0.825},
    { transform: "scale(1,-0.2)",  offset: 0.875},
    { transform: "scale(1,-0.6)",  offset: 0.95},
    { transform: "scale(1,-1)"} 
  ];
  const patanTiming = { 
    duration: 1000,
    iterations: 1,
    easing: "ease-in",
    fill: "forwards"
  };

  const fillColChange1 = [
    {fill: "blue"},
    {fill: "blue", offset: 0.825},
    {fill: "green", offset: 0.826},
    {fill: "green"}
  ];
  const fillColChange2 = [
    {fill: "green"},
    {fill: "green", offset: 0.825},
    {fill: "blue", offset: 0.826},
    {fill: "blue"}
  ];

  document.addEventListener("DOMContentLoaded", () => {
    const btn = document.getElementById("animateBtn");
    btn?.addEventListener("click", () => {beginAnimation(5);});
  });
  

</script>